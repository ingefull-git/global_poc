version: 2.1
setup: true

orbs:
  continuation: circleci/continuation@0.1.2

jobs:
  detect-market:
    docker:
      - image: cimg/python:3.10
    steps:
      - checkout
      - run:
          name: Detect updated market path
          command: |
            git fetch origin main --depth=1
            if git diff --name-only origin/main...HEAD | grep -q "src/etl/japan/"; then
              echo 'japan' > market.txt
            elif git diff --name-only origin/main...HEAD | grep -q "src/etl/common/"; then
              echo 'common' > market.txt
            else
              echo 'none' > market.txt
      - run:
          name: Select continuation config
          command: |
            MARKET=$(cat market.txt)
            if [ "$MARKET" = "common" ]; then
              echo '{"config_path": "src/etl/.circleci/continue_config_common.yml"}' > continuation-params.json
            elif [ "$MARKET" = "japan" ]; then
              echo '{"config_path": "src/etl/.circleci/continue_config_japan.yml"}' > continuation-params.json
            else
              echo 'No relevant changes detected. Exiting.'
              circleci-agent step halt
            fi
      - continuation/continue:
          configuration_path: << pipeline.parameters.config_path >>
          parameters: {}

workflows:
  setup:
    jobs:
      - detect-market
