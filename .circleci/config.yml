version: 2.1

executors:
  minimal-executor:
    docker:
      - image: cimg/base:stable

  python-service-executor:
    docker:
      - image: cimg/python:3.11
      - image: localstack/localstack:latest
        name: localstack
        environment:
          SERVICES: s3,secretsmanager
          EDGE_PORT: 4566
      - image: postgres:13
        name: postgres
        environment:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_pass
          POSTGRES_DB: test_db

jobs:
  detect-changes:
    executor: minimal-executor
    steps:
      - checkout
      - run:
          name: Detect Changed Services and Markets
          command: |
            git fetch origin main
            
            CHANGED=$(git diff --name-only origin/main | grep '^src/' || true | cut -d'/' -f2,3 | sort -u | xargs)
            MARKETS=$(git diff --name-only origin/main | grep '^db_migration/' || true | cut -d'/' -f2 | sort -u)

            for market in $MARKETS; do
              for service in etl pyapi forecast; do
                CHANGED="$CHANGED $service/$market"
              done
            done

            if [ -z "$CHANGED" ] && [ -z "$MARKETS" ]; then
              echo "No changes detected in src/ or db_migration/ directories"
            else
              echo "export CHANGED_SERVICE_MARKETS=\"$CHANGED\"" >> $BASH_ENV
              source $BASH_ENV
              echo "Changed service/markets: $CHANGED_SERVICE_MARKETS"
            fi

  test-lint-checks:
    parameters:
      service:
        type: string

    executor: python-service-executor
    steps:
      - checkout
      - run:
          name: Install requirements
          command: |
            pip install -r requirements.txt
      - run:
          name: Install Sqitch
          command: |
            sudo apt-get update && sudo apt-get install -y sqitch libpq-dev
      - run:
          name: Conditional test run for << parameters.service >>
          command: |
            source $BASH_ENV
            echo "Checking for changes in << parameters.service >>"
            if echo "$CHANGED_SERVICE_MARKETS" | grep -q "<< parameters.service >>"; then
              chmod +x src/etl/test_and_lint_checks.sh
              ./src/etl/test_and_lint_checks.sh
            else
              echo "No changes for << parameters.service >>. Skipping."
            fi

workflows:
  version: 2
  main-pipeline:
    jobs:
      - detect-changes
      - test-lint-checks:
          name: test-etl
          service: "etl"
          requires:
            - detect-changes
      
      - test-lint-checks:
          name: test-pyapi
          service: "pyapi"
          requires:
            - detect-changes

      - test-lint-checks:
          name: test-forecast
          service: "forecast"
          requires:
            - detect-changes
